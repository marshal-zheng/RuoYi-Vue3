# 设备拓扑图功能实现说明

## 功能概述

已实现从后端API获取设备列表，并在拓扑图中支持设备节点的拖拽、端口连接等功能。

## 实现的功能

### 1. 动态加载设备列表
- ✅ 从后端 API 获取设备列表数据（`/protocol/device/list`）
- ✅ 分页参数：`pageNum=1`, `pageSize=999`
- ✅ 并发获取每个设备的端口信息（`/protocol/device/busInterface/list`）

### 2. 设备节点渲染
- ✅ 使用 `DevicePortNode.vue` 组件渲染设备节点
- ✅ 显示设备名称、设备类型、总线类型等信息
- ✅ 端口自动分配到四个方向（top/right/bottom/left）
- ✅ 端口类型标识（input/output/bidirectional）

### 3. 端口连接支持
- ✅ 端口信息包含在节点数据中
- ✅ X6 端口用于连线逻辑
- ✅ 自定义端口视觉由 `DevicePortNode.vue` 渲染
- ✅ 支持拖拽连线

### 4. 数据转换
- ✅ 将后端设备数据转换为 DAG 组件需要的格式
- ✅ 端口类型映射（输入→input，输出→output，其他→bidirectional）
- ✅ 端口均匀分配到四个方向

## 文件修改清单

### 1. `/src/views/protocol/project/detail.vue`
**主要改动：**
- 引入设备 API：`listDevice`, `listDeviceBusInterface`
- 实现 `loadDeviceList()` 函数，从后端加载设备列表
- 实现 `getDevicePorts()` 函数，获取设备端口信息
- 数据转换：将后端数据转换为 operators 格式

**数据结构：**
```javascript
{
  // DAG 组件需要的字段
  name: '设备名称',
  value: '设备描述',
  category: '设备分类',
  
  // 设备原始数据
  deviceId: 123,
  deviceType: '类型',
  busType: '总线类型',
  manufacturer: '厂商',
  model: '型号',
  version: '版本',
  
  // 端口信息（用于连接桩）
  ports: [
    {
      id: 'port-1',
      interfaceId: 1,
      interfaceName: '端口名称',
      interfaceType: 'input|output|bidirectional',
      group: 'top|right|bottom|left',
      description: '端口描述',
      busType: '总线类型',
      dataRate: '数据速率',
      protocolType: '协议类型'
    }
  ],
  
  // 节点类型标识
  nodeType: 'device-port-node'
}
```

### 2. `/src/components/business/Dag/components/DagDnd.vue`
**主要改动：**
- 引入 `DEVICE_PORT_NODE` shape
- 修改 `handleMouseDown()` 函数，支持设备节点拖拽
- 根据节点类型（是否有 ports 数据）选择不同的 shape
- 设备节点使用端口信息创建 X6 连接桩
- 将设备数据传递到节点 data 中

**判断逻辑：**
```javascript
const isDeviceNode = item.originalData?.nodeType === 'device-port-node' && 
                     item.originalData?.ports && 
                     Array.isArray(item.originalData.ports)
```

## 使用方式

### 1. 访问页面
打开项目详情页面：`/protocol/project/detail`

### 2. 左侧设备库
- 页面加载时自动从后端获取设备列表
- 设备按分类展示
- 支持搜索功能

### 3. 拖拽创建节点
- 从左侧设备库拖拽设备到画布
- 自动创建设备节点，包含端口信息
- 端口显示在设备四周

### 4. 连接设备
- 从一个设备的端口拖拽到另一个设备的端口
- 支持端口类型校验（output → input/bidirectional）
- 自动绘制连接线

## 端口分配规则

端口按索引均匀分配到四个方向：
```javascript
const groups = ['top', 'right', 'bottom', 'left']
const group = groups[index % 4]
```

- 第 1 个端口 → top
- 第 2 个端口 → right
- 第 3 个端口 → bottom
- 第 4 个端口 → left
- 第 5 个端口 → top
- ...依此类推

## 端口类型映射

从后端接口类型映射到前端端口类型：
```javascript
if (intf.interfaceType === '输入' || intf.interfaceType === 'input') {
  interfaceType = 'input'
} else if (intf.interfaceType === '输出' || intf.interfaceType === 'output') {
  interfaceType = 'output'
} else {
  interfaceType = 'bidirectional' // 默认双向
}
```

## 注意事项

### 1. API 依赖
需要确保后端以下接口正常工作：
- `GET /protocol/device/list` - 获取设备列表
- `GET /protocol/device/busInterface/list` - 获取设备端口信息

### 2. 数据要求
设备数据应包含：
- `deviceId` - 设备ID（必需）
- `deviceName` - 设备名称（必需）
- `categoryName` - 分类名称（可选，默认"未分类"）
- 其他字段可选

端口数据应包含：
- `interfaceId` - 接口ID
- `interfaceName` - 接口名称
- `interfaceType` - 接口类型（输入/输出）
- 其他字段可选

### 3. 性能考虑
- 并发获取所有设备的端口信息，使用 `Promise.all()`
- 如果设备数量很多（>100），可能需要优化为按需加载

### 4. 错误处理
- 加载失败时显示错误提示
- 设备无端口时仍可创建节点（端口数组为空）
- 单个设备端口获取失败不影响其他设备

## 后续优化建议

1. **端口位置智能分配**
   - 根据端口类型智能分配位置（如 input 在左/上，output 在右/下）
   - 支持自定义端口位置

2. **端口配置**
   - 支持在后端配置端口的显示位置
   - 支持端口顺序调整

3. **性能优化**
   - 虚拟滚动加载设备列表
   - 端口信息懒加载（只在节点创建时获取）

4. **用户体验**
   - 端口悬浮提示（显示详细信息）
   - 端口高亮显示（可连接的端口）
   - 连接校验提示（不兼容的端口类型）

5. **数据持久化**
   - 保存拓扑图数据到后端
   - 加载已保存的拓扑图

## 技术栈

- **前端框架**: Vue 3
- **图形库**: AntV X6
- **UI 组件**: Element Plus
- **状态管理**: Vue 3 Composition API
- **HTTP 请求**: axios（通过 request.js 封装）

## 联系方式

如有问题，请联系开发团队。





